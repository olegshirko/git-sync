# Детальный план архитектуры сервиса синхронизации Git на Go

## 1. Обзор:
Go-сервис для двусторонней синхронизации полных Git-репозиториев (включая все ветки и историю коммитов) между GitLab и приватным репозиторием. Сервис будет запускаться вручную, выполнять синхронизацию один раз и затем завершать работу. Аутентификация: GitLab - Personal Access Token, Приватный репозиторий - SSH-ключи.

## 2. Основные компоненты сервиса:

*   **Конфигурация:**
    *   Файл конфигурации (например, `config.yaml` или переменные окружения) для хранения:
        *   Personal Access Token для GitLab.
        *   Путь к SSH-ключу для приватного репозитория.
        *   Список репозиториев для синхронизации (пары GitLab URL <-> Private Repo URL).
        *   Путь к временной директории для клонирования репозиториев.
*   **Менеджер репозиториев (Repository Manager):**
    *   Отвечает за клонирование, обновление (pull/fetch), пуш и удаление локальных копий репозиториев.
    *   Использует Go-библиотеки для работы с Git (например, `go-git`).
    *   Обрабатывает аутентификацию для GitLab (PAT) и приватного репозитория (SSH).
*   **Логика синхронизации (Sync Logic):**
    *   Основной компонент, который определяет, какие изменения нужно синхронизировать и в каком направлении.
    *   Для каждого репозитория:
        *   Клонирует или обновляет локальные копии GitLab и приватного репозитория.
        *   Сравнивает состояние веток в обоих репозиториях.
        *   Определяет, какие коммиты отсутствуют в одном из репозиториев.
        *   Выполняет `git push` для синхронизации изменений.
        *   Обрабатывает конфликты (если применимо, хотя для полной синхронизации это менее критично, чем для слияния).
*   **Обработчик ошибок и логирование (Error Handling & Logging):**
    *   Записывает все операции, ошибки и предупреждения в лог-файл.
    *   Предоставляет информацию о статусе синхронизации.

## 3. Сценарии работы:

*   **Запуск вручную:**
    1.  Сервис запускается.
    2.  Загружает конфигурацию.
    3.  Инициализирует менеджер репозиториев.
    4.  Для каждой пары репозиториев:
        *   Менеджер репозиториев клонирует/обновляет GitLab репозиторий.
        *   Менеджер репозиториев клонирует/обновляет приватный репозиторий.
        *   Логика синхронизации сравнивает ветки:
            *   Если в GitLab есть коммиты, которых нет в приватном репозитории, они пушатся в приватный.
            *   Если в приватном репозитории есть коммиты, которых нет в GitLab, они пушатся в GitLab.
        *   Логирование результатов.
    5.  Сервис завершает работу.
*   **Обработка ошибок:**
    *   При ошибках клонирования, пуша или других Git-операций, сервис должен логировать ошибку и, возможно, завершить работу с соответствующим кодом выхода.

## 4. Архитектурная схема (Mermaid):

```mermaid
graph TD
    A[Запуск Сервиса (Вручную)] --> B(Конфигурация)
    B --> C[Менеджер Репозиториев]
    C --> D[Логика Синхронизации]

    D -- Для каждой пары репозиториев --> E[GitLab Репозиторий]
    D -- Для каждой пары репозиториев --> F[Приватный Репозиторий]

    E -- Данные Git --> D
    F -- Данные Git --> D

    D -- Push изменений --> E
    D -- Push изменений --> F

    D --> G[Логирование]
    C --> G
    A --> G
    G --> H[Завершение Сервиса]
```

## 5. Особенности реализации:

*   **Использование `go-git`:** Эта библиотека позволит работать с Git-репозиториями на уровне Go-кода, без необходимости вызывать внешние команды `git`.
*   **Обработка SSH-ключей:** Для приватного репозитория потребуется корректная настройка SSH-агента или передача SSH-ключа напрямую в `go-git`.
*   **Обработка Personal Access Token:** Для GitLab токен будет использоваться для аутентификации HTTP/HTTPS запросов.
*   **Временные директории:** Репозитории будут клонироваться во временные директории, которые будут очищаться после синхронизации или при завершении работы сервиса.
*   **Идемпотентность:** Операции синхронизации должны быть идемпотентными, то есть повторное выполнение не должно приводить к нежелательным побочным эффектам.

## 6. Различия между "Домом" и "Работой":

*   **На работе:** Сервис будет иметь полный доступ к GitLab (через REST API для пуша, через Git для клонирования) и к приватному репозиторию (через Git с SSH).
*   **Дома:** Сервис будет иметь доступ только к GitLab (через Git для клонирования и пуша). Это означает, что синхронизация "Приватный -> GitLab" будет работать только на работе. Синхронизация "GitLab -> Приватный" не будет работать дома, так как нет доступа к приватному репозиторию.
*   **Решение:** Сервис должен быть развернут на машине, которая имеет доступ к обоим репозиториям (т.е. на работе). Если дома нужен только GitLab, то это просто обычный Git-клиент.

## Предлагаемый план действий:

1.  **Определение структуры проекта Go:** Создание базовой структуры каталогов для сервиса.
2.  **Реализация модуля конфигурации:** Чтение параметров из файла или переменных окружения.
3.  **Реализация менеджера репозиториев:** Функции для клонирования, пуша, пулла с учетом аутентификации.
4.  **Реализация логики синхронизации:** Сравнение веток и выполнение Git-операций.
5.  **Добавление логирования и обработки ошибок.**
6.  **Тестирование:** Юнит-тесты и интеграционные тесты.